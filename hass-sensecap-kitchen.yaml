substitutions:
  name: hass-sensecap-kitchen
  friendly_name: "SenseCAP Kitchen"
  comment: Seeed SenseCap D1 Indicator
  board: esp32-s3-devkitc-1

packages:
  common: !include packages/common-32-api.yaml

esp32:
  variant: esp32s3
  flash_size: 8MB
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_ESPTOOLPY_FLASHSIZE_8MB: y
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: y
      CONFIG_ESP32S3_DATA_CACHE_64KB: y
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: y
      CONFIG_SPIRAM_RODATA: y

logger:
  hardware_uart: UART0

api:
  on_client_connected:
    - lvgl.widget.show: lbl_hastatus
  on_client_disconnected:
    then:
      - if:
          condition:
            not:
              api.connected:
          then:
            - lvgl.widget.hide: lbl_hastatus

time:
  - platform: homeassistant
    id: !extend hass_time
    on_time_sync:
      - script.execute: time_update
    on_time:
      - minutes: '*'
        seconds: 0
        then:
          - script.execute: time_update

script:
  - id: time_update
    then:
      - lvgl.label.update:
          id: lbl_clock
          text: !lambda |-
            return id(hass_time).now().strftime("%H:%M").c_str();

binary_sensor:
  - platform: gpio
    name: Button
    pin:
      number: GPIO38
      inverted: true
      mode:
        input: true
        pullup: true
    on_click: 
      then:
        - lvgl.page.next
  - platform: homeassistant
    id: media_playing
    entity_id: binary_sensor.sonos_kjokken_playing
    internal: true
  - platform: homeassistant
    id: media_muted
    entity_id: binary_sensor.sonos_kjokken_muted
    internal: true

sensor:
  - platform: homeassistant
    id: temperature_outdoor
    entity_id: sensor.hass_outdoor_temp_01_temperature
    internal: true
    on_value:
      - lvgl.label.update:
          id: lbl_temperature_outdoor
          text:
            format: "%.1f°C"
            args: [ 'x + .05' ]
  - platform: homeassistant
    id: temperature_kitchen
    entity_id: sensor.kjokken_sensor_1_temperature
    internal: true
    on_value:
      - lvgl.label.update:
          id: lbl_temperature_kitchen
          text:
            format: "%.1f°C"
            args: [ 'x + .05' ]
  - platform: homeassistant
    id: temperature_martin
    entity_id: sensor.martin_sensor_1_temperature
    internal: true
    on_value:
      - lvgl.label.update:
          id: lbl_temperature_martin
          text:
            format: "%.1f°C"
            args: [ 'x + .05' ]
  - platform: homeassistant
    id: temperature_eivind
    entity_id: sensor.eivind_sensor_1_temperature
    internal: true
    on_value:
      - lvgl.label.update:
          id: lbl_temperature_eivind
          text:
            format: "%.1f°C"
            args: [ 'x + .05' ]
  - platform: homeassistant
    id: media_volume
    entity_id: sensor.sonos_kjokken_volume
    internal: true

text_sensor:
  - platform: homeassistant
    id: light_martin
    entity_id: light.silicon_labs_ezsp_martin_taklys
    internal: true
    on_value: !include
      file: testing.yaml
      vars:
        label: lbl_lightbulb_martin
  - platform: homeassistant
    id: light_eivind
    entity_id: light.eivind_taklys_light
    internal: true
    on_value: !include
      file: testing.yaml
      vars:
        label: lbl_lightbulb_eivind
  - platform: homeassistant
    id: light_kitchen
    entity_id: light.kjokken_powerplugg_1_switch
    internal: true
    on_value: !include
      file: testing.yaml
      vars:
        label: lbl_lightbulb_kitchen
  - platform: homeassistant
    id: media_artist
    entity_id: sensor.sonos_kjokken_artist
    internal: true
  - platform: homeassistant
    id: media_channel
    entity_id: sensor.sonos_kjokken_channel
    internal: true
  - platform: homeassistant
    id: media_title
    entity_id: sensor.sonos_kjokken_title
    internal: true
  - platform: homeassistant
    id: media_album
    entity_id: sensor.sonos_kjokken_album
    internal: true

psram:
  mode: octal
  speed: 80MHz

output:
  - platform: ledc
    pin:
      number: GPIO45
      ignore_strapping_warning: true
    id: ledc_gpio45
    frequency: 100Hz

i2c:
  - id: bus_a
    sda: GPIO39
    scl: GPIO40
    scan: false

spi:
  - id: lcd_spi
    clk_pin: GPIO41
    mosi_pin: GPIO48

pca9554:
  - id: pca9554a_device
    address: 0x20
    pin_count: 16

display:
  - platform: st7701s
    id: sensecap_display
    auto_clear_enabled: false
    data_rate: 4MHz
    update_interval: never
    spi_mode: MODE3
    color_order: RGB
    dimensions:
      width: 480
      height: 480
    invert_colors: true
    transform:
      mirror_x: true
      mirror_y: true
    cs_pin:
      pca9554: pca9554a_device
      number: 4
    reset_pin:
      pca9554: pca9554a_device
      number: 5
    de_pin: GPIO18
    hsync_pin: GPIO16
    vsync_pin: GPIO17
    pclk_pin: GPIO21
    init_sequence:
      - 1 # select canned init sequence number 1
      - delay 5ms
      - [0xE0, 0x1F] # Set sunlight readable enhancement
    data_pins:
      red:
        - GPIO4 #r1
        - GPIO3 #r2
        - GPIO2 #r3
        - GPIO1 #r4
        - GPIO0 #r5
      green:
        - GPIO10 #g0
        - GPIO9 #g1
        - GPIO8 #g2
        - GPIO7 #g3
        - GPIO6 #g4
        - GPIO5 #g5
      blue:
        - GPIO15 #b1
        - GPIO14 #b2
        - GPIO13 #b3
        - GPIO12 #b4
        - GPIO11 #b5

light:
  - platform: monochromatic
    name: "Backlight"
    id: backlight
    output: ledc_gpio45
    restore_mode: ALWAYS_ON

touchscreen:
  platform: ft5x06
  id: sensecap_touchscreen
  transform:
    mirror_x: true
    mirror_y: true

# Basic Config
image:
  - file: bg_autumn.jpg
    id: img_bg
    type: RGB565

lvgl:
  disp_bg_image: img_bg
  theme:
    button:
      bg_color: 0x444444
      shadow_width: 0
      border_opa: COVER
      border_width: 1
      border_color: 0x666666
    obj:
      border_opa: COVER
      border_width: 1
      border_color: 0x666666
      bg_color: 0x00000
      bg_opa: 35%
    label:
      text_color: 0xffffff
  style_definitions:
    - id: page
      bg_opa: TRANSP
      pad_top: 100
      pad_left: 20
      pad_right: 20
      pad_bottom: 20
  top_layer:
    widgets:
      - label:
          id: lbl_clock
          text: '--:--'
          text_color: 0xffffff
          text_font: f_24
          x: 20
          y: 20
      - label:
          text: "\uF1EB"
          id: lbl_hastatus
          align: top_right
          text_font: montserrat_24 
          x: -20
          y: 20
          text_align: right
          text_color: 0xFFFFFF
          hidden: true
  on_idle:
    - timeout: 30s
      then:
        - lvgl.page.show: main_page
  pages:
    - id: main_page
      styles: page
      on_swipe_left:
        - lvgl.page.next:
      on_swipe_right:
        - lvgl.page.previous:
      widgets:
        - obj:
            bg_opa: 35%
            bg_color: 0x000000
            width: 210
            height: SIZE_CONTENT
            align: TOP_LEFT
            widgets:
              - label:
                  text: 'Utendørs'
                  text_font: f_24
                  text_color: 0xffffff
              - label:
                  id: lbl_temperature_outdoor
                  text: '--.-°C'
                  width: 100%
                  text_align: CENTER
                  text_font: f_48
                  text_color: 0xffffff
                  y: 30
        - obj:
            bg_opa: 35%
            bg_color: 0x000000
            width: 210
            height: SIZE_CONTENT
            align: TOP_RIGHT
            widgets:
              - label:
                  text: 'Kjøkken'
                  text_font: f_24
                  text_color: 0xffffff
              - label:
                  id: lbl_temperature_kitchen
                  text: '--.-°C'
                  width: 100%
                  text_align: CENTER
                  text_font: f_48
                  text_color: 0xffffff
                  y: 30
        - button:
            width: 60
            height: 60
            align: BOTTOM_LEFT
            id: btn_lightbulb_kitchen
            widgets:
              - label:
                  id: lbl_lightbulb_kitchen
                  align: CENTER
                  text_font: mdi_42
                  text: "\U000F0336" # mdi-lightbulb-outline
                  text_color: 0xffffff    
                  checked:
                    text_color: 0xffea00
            on_short_click:
              - homeassistant.action:
                  action: light.toggle
                  data:
                    entity_id: light.kjokken_powerplugg_1_switch
    - id: page_martin
      styles: page
      on_swipe_left:
        - lvgl.page.next:
      on_swipe_right:
        - lvgl.page.previous:
      widgets:
        - label:
            text: 'Martin'
            text_font: f_44b
            align: TOP_MID
            y: -100
        - obj:
            bg_opa: 35%
            bg_color: 0x000000
            width: 210
            height: SIZE_CONTENT
            align: TOP_LEFT
            widgets:
              - label:
                  text: 'Temperatur'
                  text_font: f_24
                  text_color: 0xffffff
              - label:
                  id: lbl_temperature_martin
                  text: '--.-°C'
                  width: 100%
                  text_align: CENTER
                  text_font: f_48
                  text_color: 0xffffff
                  y: 30
        - button:
            width: 60
            height: 60
            align: BOTTOM_LEFT
            id: btn_lightbulb_martin
            widgets:
              - label:
                  id: lbl_lightbulb_martin
                  align: CENTER
                  text_font: mdi_42
                  text: "\U000F0336" # mdi-lightbulb-outline
                  text_color: 0xffffff    
                  checked:
                    text_color: 0xffea00
            on_short_click:
              - homeassistant.action:
                  action: light.toggle
                  data:
                    entity_id: light.silicon_labs_ezsp_martin_taklys
    - id: page_eivind
      styles: page
      on_swipe_left:
        - lvgl.page.next:
      on_swipe_right:
        - lvgl.page.previous:
      widgets:
        - label:
            text: 'Eivind'
            text_font: f_44b
            align: TOP_MID
            y: -100
        - obj:
            bg_opa: 35%
            bg_color: 0x000000
            width: 210
            height: SIZE_CONTENT
            align: TOP_LEFT
            widgets:
              - label:
                  text: 'Temperatur'
                  text_font: f_24
                  text_color: 0xffffff
              - label:
                  id: lbl_temperature_eivind
                  text: '--.-°C'
                  width: 100%
                  text_align: CENTER
                  text_font: f_48
                  text_color: 0xffffff
                  y: 30
        - button:
            width: 60
            height: 60
            align: BOTTOM_LEFT
            id: btn_lightbulb_eivind
            widgets:
              - label:
                  id: lbl_lightbulb_eivind
                  align: CENTER
                  text_font: mdi_42
                  text: "\U000F0336" # mdi-lightbulb-outline
                  text_color: 0xffffff    
                  checked:
                    text_color: 0xffea00
            on_short_click:
              - homeassistant.action:
                  action: light.toggle
                  data:
                    entity_id: light.eivind_taklys_light

font:
  - file: gfonts://Montserrat@Medium
    size: 24
    bpp: 4
    id: f_24
    glyphsets:
      - GF_Latin_Core
  - file: gfonts://Montserrat@Medium
    size: 42
    bpp: 4
    id: f_42
    glyphsets:
      - GF_Latin_Core
    extras: 
      - file: https://github.com/Templarian/MaterialDesign-Webfont/raw/refs/heads/master/fonts/materialdesignicons-webfont.ttf
        glyphs: [
          "\U000F0335", # mdi-lightbulb
          "\U000F0336", # mdi-lightbulb-outline
        ]      
  - file: gfonts://Montserrat@Medium
    size: 48
    bpp: 4
    id: f_48
    glyphsets:
      - GF_Latin_Core
  - file: gfonts://Montserrat@Bold
    size: 44
    bpp: 4
    id: f_44b
    glyphsets:
      - GF_Latin_Core
  - file: https://github.com/Templarian/MaterialDesign-Webfont/raw/refs/heads/master/fonts/materialdesignicons-webfont.ttf
    id: mdi_42
    size: 42
    bpp: 4
    glyphs: [
      "\U000F0335", # mdi-lightbulb
      "\U000F0336", # mdi-lightbulb-outline
      ]